{% extends "patient/base.html" %}
{% load static i18n %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-xl w-full space-y-8 bg-white p-10 rounded-xl shadow-lg">
        <div>
            <h1 class="text-center text-3xl font-extrabold text-gray-900">
                Chunked File Upload
            </h1>
        </div>

        <div class="space-y-4 rounded-md shadow-sm">
            <h3 class="text-lg font-medium text-gray-700 pt-4">Authentication</h3>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <input type="text" id="username" placeholder="Username" value="admin" class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm">
                <input type="password" id="password" placeholder="Password" value="admin" class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm">
            </div>
            <button id="loginButton" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Login
            </button>
            <div id="token-status" class="text-sm text-center font-medium h-5"></div>
        </div>

        <hr class="border-gray-200">

        <div class="space-y-4">
            <h3 class="text-lg font-medium text-gray-700">Upload Scan</h3>
            <div>
                <label for="scanIdInput" class="block text-sm font-medium text-gray-700">Scan ID to associate with:</label>
                <input type="number" id="scanIdInput" value="1" class="mt-1 appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm">
            </div>
            
            <div>
                 <label class="block text-sm font-medium text-gray-700">File to upload</label>
                <input type="file" id="fileInput" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </div>

            <button id="uploadButton" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                Upload
            </button>
            <div id="progress" class="text-sm text-center font-medium text-gray-600 h-5"></div>
        </div>
    </div>
</div>
{% endblock %}


{% block javascript %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>

    <script type="text/javascript">
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const progressDiv = document.getElementById('progress');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const tokenDiv = document.getElementById('token-status');
        const scanIdInput = document.getElementById('scanIdInput');

        const CHUNK_SIZE = 1024 * 1024 * 5; // 5MB
        const UPLOAD_URL = '/api/patient/scans/upload/';
        const TOKEN_URL = '/api/token/';

        let accessToken = null;

        loginButton.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            tokenDiv.innerText = 'Logging in...';
            try {
                const response = await fetch(TOKEN_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData));
                }

                const data = await response.json();
                accessToken = data.access;
                tokenDiv.innerText = 'Logged in successfully!';
                tokenDiv.style.color = 'green';
            } catch (error) {
                tokenDiv.innerText = `Login failed: ${error.message}`;
                tokenDiv.style.color = 'red';
                console.error('Login failed:', error);
            }
        });

        const calculateMD5 = (file, callback) => {
            const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;
            const chunks = Math.ceil(file.size / CHUNK_SIZE);
            let currentChunk = 0;
            const spark = new SparkMD5.ArrayBuffer();
            const fileReader = new FileReader();

            fileReader.onload = (e) => {
                spark.append(e.target.result);
                currentChunk++;
                progressDiv.innerText = `Calculating MD5: ${Math.round((currentChunk/chunks)*100)}%`;
                if (currentChunk < chunks) {
                    loadNextChunk();
                } else {
                    callback(spark.end());
                }
            };
            fileReader.onerror = () => {
                console.error('MD5 calculation failed');
                progressDiv.innerText = 'Error calculating MD5.';
                progressDiv.style.color = 'red';
            };
            const loadNextChunk = () => {
                const start = currentChunk * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
            };
            loadNextChunk();
        };

        uploadButton.addEventListener('click', () => {
            if (!accessToken) {
                progressDiv.innerText = 'Please log in first.';
                progressDiv.style.color = 'orange';
                return;
            }
            const file = fileInput.files[0];
            if (!file) {
                progressDiv.innerText = 'Please select a file.';
                progressDiv.style.color = 'orange';
                return;
            }

            progressDiv.innerText = 'Calculating MD5 checksum...';
            progressDiv.style.color = 'black';

            calculateMD5(file, (md5) => {
                progressDiv.innerText = `MD5: ${md5}. Starting upload...`;
                startUpload(file, md5);
            });
        });

        async function startUpload(file, md5) {
            const scanId = scanIdInput.value;
            if (!scanId) {
                progressDiv.innerText = 'Scan ID is required.';
                return;
            }

            const totalSize = file.size;
            let start = 0;
            let uploadUrl = UPLOAD_URL; // First request goes to the base URL
            let isFirstChunk = true;

            try {
                while (start < totalSize) {
                    const end = Math.min(start + CHUNK_SIZE, totalSize);
                    const chunk = file.slice(start, end);
                    const contentRange = `bytes ${start}-${end - 1}/${totalSize}`;

                    progressDiv.innerText = `Uploading chunk... ${Math.round((end/totalSize)*100)}%`;

                    const formData = new FormData();
                    formData.append('file', chunk);
                    formData.append('filename', file.name);

                    // Add scan ID only to the first chunk's request
                    if (isFirstChunk) {
                        formData.append('scan', scanId);
                    }

                    const chunkResponse = await fetch(uploadUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Range': contentRange,
                            'Authorization': `Bearer ${accessToken}`,
                        },
                        body: formData,
                    });

                    if (!chunkResponse.ok) {
                        const errorData = await chunkResponse.json();
                        throw new Error(`Chunk upload failed: ${JSON.stringify(errorData)}`);
                    }

                    const responseData = await chunkResponse.json();
                    uploadUrl = responseData.url; // Use the new URL for subsequent chunks
                    isFirstChunk = false;
                    start = end;
                }

                // Finalize upload
                progressDiv.innerText = 'Finalizing upload...';
                const finalResponse = await fetch(uploadUrl, { // Use the last received URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                    },
                    body: JSON.stringify({ md5: md5 }),
                });

                if (!finalResponse.ok) {
                    const errorData = await finalResponse.json();
                    throw new Error(`Finalization failed: ${JSON.stringify(errorData)}`);
                }
                
                const finalData = await finalResponse.json();
                progressDiv.innerText = 'Upload complete!';
                progressDiv.style.color = 'green';
                console.log('Final response:', finalData);

            } catch (error) {
                progressDiv.innerText = `Error: ${error.message}`;
                progressDiv.style.color = 'red';
                console.error('Upload failed:', error);
            }
        }
    </script>
{% endblock %}
